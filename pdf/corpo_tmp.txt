from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
import calendar

def desenhar_tabela(c, ano, mes, he=None, hs=None, y_top=None):
    largura_pagina, altura_pagina = A4

    # ------------------------------
    # ConfiguraÃ§Ã£o bÃ¡sica
    # ------------------------------
    MESES_PT = {
        1: "JANEIRO", 2: "FEVEREIRO", 3: "MARÃ‡O", 4: "ABRIL",
        5: "MAIO", 6: "JUNHO", 7: "JULHO", 8: "AGOSTO",
        9: "SETEMBRO", 10: "OUTUBRO", 11: "NOVEMBRO", 12: "DEZEMBRO",
    }
    nome_mes = MESES_PT.get(mes, "")

    # Valores de exemplo (depois parametrizamos)
    nome_reeducando = "ADENIR BELING"
    funcao = "AUXILIAR DE SERVIÃ‡OS GERAIS"
    data_inclusao = "11/11/2019"
    endereco = "RUA CECILIA PINHEIRO S/NÂº, SOB ESQUINA MAL RONDON, SAO MIGUEL DO GUAPORÃ‰"
    cep = "76.932-000"
    telefone = "69 99245-2646"
    municipio = "SÃƒO MIGUEL DO GUAPORÃ‰"
    cpf = "753.210.922-49"
    banco = "01"
    agencia = "2292-6"
    conta = "23.061-8"

    # PosiÃ§Ã£o da tabela: usa valor fornecido pelo cabeÃ§alho ou cai no padrÃ£o
    if y_top is None:
        y_top = altura_pagina - 34 * mm   # margem padrÃ£o caso nÃ£o venha coordenada do cabeÃ§alho

    # Largura da tabela: 14,8 cm (nÃ£o estoura a margem)
    largura_tabela = 148 * mm
    altura_titulo  = 6 * mm           # 1Âª linha
    altura_linha   = 5 * mm           # demais linhas

    # Centraliza a tabela na pÃ¡gina
    x = (largura_pagina - largura_tabela) / 2

    # padding interno
    pad = 1.5 * mm

    c.setLineWidth(1)
    c.setStrokeColorRGB(0, 0, 0)
    c.setFillColorRGB(0, 0, 0)

    # ------------------------------------------------------------
    # 1Âª LINHA â€“ REGISTRO INDIVIDUAL DE PONTO
    # ------------------------------------------------------------
    y1 = y_top - altura_titulo
    c.rect(x, y1, largura_tabela, altura_titulo, fill=0)

    c.setFont("Helvetica-Bold", 12)   # Arial Black 12 ~
    c.drawCentredString(
        x + largura_tabela / 2,
        y1 + (altura_titulo / 2) - 4,
        "REGISTRO INDIVIDUAL DE PONTO"
    )
    y_atual = y1

    # ------------------------------------------------------------
    # 2Âª LINHA â€“ SECRETARIA / ANO (linha corta antes do ANO)
    # ------------------------------------------------------------
    y2 = y_atual - altura_linha
    c.rect(x, y2, largura_tabela, altura_linha, fill=0)

    c.setFont("Helvetica-Bold", 11)
    texto_ano = f"ANO: {ano}"
    largura_texto_ano = c.stringWidth(texto_ano, "Helvetica-Bold", 11)

    x_ano = x + largura_tabela - pad - largura_texto_ano
    x_div1 = x_ano - pad
    c.line(x_div1, y2, x_div1, y2 + altura_linha)

    c.drawString(
        x + pad,
        y2 + (altura_linha / 2) - 3,
        "SECRETARIA: SECRETARIA DE ESTADO DA JUSTIÃ‡A - SEJUS"
    )
    c.drawString(
        x_ano,
        y2 + (altura_linha / 2) - 3,
        texto_ano
    )
    y_atual = y2

    # ------------------------------------------------------------
    # 3Âª LINHA â€“ REEDUCANDO / MÃŠS
    # ------------------------------------------------------------
    y3 = y_atual - altura_linha
    c.rect(x, y3, largura_tabela, altura_linha, fill=0)

    largura_reeducando = largura_tabela * 0.70
    c.line(x + largura_reeducando, y3, x + largura_reeducando, y3 + altura_linha)

    c.drawString(
        x + pad,
        y3 + (altura_linha / 2) - 3,
        f"REEDUCANDO: {nome_reeducando}"
    )
    c.drawString(
        x + largura_reeducando + pad,
        y3 + (altura_linha / 2) - 3,
        f"MÃŠS: {nome_mes}"
    )
    y_atual = y3

    # ------------------------------------------------------------
    # 4Âª LINHA â€“ FUNÃ‡ÃƒO
    # ------------------------------------------------------------
    y4 = y_atual - altura_linha
    c.rect(x, y4, largura_tabela, altura_linha, fill=0)

    c.drawString(
        x + pad,
        y4 + (altura_linha / 2) - 3,
        f"FUNÃ‡ÃƒO: {funcao}"
    )
    y_atual = y4

    # ------------------------------------------------------------
    # 5Âª LINHA â€“ DATA DA INCLUSÃƒO / MUNICÃPIO
    # ------------------------------------------------------------
    y5 = y_atual - altura_linha
    c.rect(x, y5, largura_tabela, altura_linha, fill=0)

    c.setFont("Helvetica-Bold", 11)
    texto_data = f"DATA DA INCLUSÃƒO: {data_inclusao}"
    largura_texto_data = c.stringWidth(texto_data, "Helvetica-Bold", 11)

    x_fim_data = x + pad + largura_texto_data + 2
    c.line(x_fim_data, y5, x_fim_data, y5 + altura_linha)

    c.drawString(
        x + pad,
        y5 + (altura_linha / 2) - 3,
        texto_data
    )
    c.drawString(
        x_fim_data + pad,
        y5 + (altura_linha / 2) - 3,
        f"MUNICÃPIO: {municipio}"
    )
    y_atual = y5

    # ------------------------------------------------------------
    # 6Âª LINHA â€“ CPF / BCO / AG / CONTA
    # ------------------------------------------------------------
    y6 = y_atual - altura_linha
    c.rect(x, y6, largura_tabela, altura_linha, fill=0)

    larg_cpf = largura_tabela * 0.45
    larg_bco = largura_tabela * 0.13
    x_cpf_fim = x + larg_cpf
    x_bco_fim = x_cpf_fim + larg_bco

    c.line(x_cpf_fim, y6, x_cpf_fim, y6 + altura_linha)
    c.line(x_bco_fim, y6, x_bco_fim, y6 + altura_linha)

    c.drawString(
        x + pad,
        y6 + (altura_linha / 2) - 3,
        f"CPF: {cpf}"
    )
    c.drawString(
        x_cpf_fim + pad,
        y6 + (altura_linha / 2) - 3,
        f"BCO: {banco}"
    )
    c.drawString(
        x_bco_fim + pad,
        y6 + (altura_linha / 2) - 3,
        f"AG: {agencia} CONTA: {conta}"
    )
    y_atual = y6

    # ------------------------------------------------------------
    # 7Âª LINHA â€“ TIPO DE CONTA
    # ------------------------------------------------------------
    y7 = y_atual - altura_linha
    c.rect(x, y7, largura_tabela, altura_linha, fill=0)

    c.drawString(
        x + pad,
        y7 + (altura_linha / 2) - 3,
        "TIPO DE CONTA: (X) CORRENTE ( ) SALÃRIO ( ) POUPANÃ‡A"
    )

    # ------------------------------------------------------------
    # EspaÃ§o entre a primeira tabela e a segunda tabela
    # ------------------------------------------------------------
    espaco_entre_tabelas = 1 * mm
    y_atual = y7 - espaco_entre_tabelas

    # ============================================================
    # CABEÃ‡ALHO DA SEGUNDA TABELA
    # DIA | HE | ENTRADA MANHA | HS | SAÃDA TARDE | (coluna OBS)
    # ============================================================
    altura_cabecalho_dias = 5 * mm

    # --------------------------------------------------------
    # larguras das colunas (ultima mais estreita, ganho vai
    # para ENTRADA MANHA e SAÃDA TARDE)
    # --------------------------------------------------------
    largura_col_dia = 12 * mm
    largura_col_he  = 10 * mm
    largura_col_hs2 = 10 * mm

    # largura fixa (mais estreita) para a coluna de observaÃ§Ãµes
    largura_col_extra = 14 * mm  # coluna de observaÃ§Ãµes mais estreita

    # o que sobra serÃ¡ dividido entre ENTRADA MANHA e SAÃDA TARDE
    largura_restante = (
        largura_tabela
        - (largura_col_dia + largura_col_he + largura_col_hs2 + largura_col_extra)
    )
    largura_col_entra = largura_restante / 2.0
    largura_col_saida = largura_restante / 2.0

    x0 = x
    x1 = x0 + largura_col_dia
    x2 = x1 + largura_col_he
    x3 = x2 + largura_col_entra
    x4 = x3 + largura_col_hs2
    x5 = x4 + largura_col_saida
    x6 = x5 + largura_col_extra  # = x + largura_tabela

    # cabeÃ§alho sÃ³ atÃ© SAÃDA TARDE (NÃƒO pega a Ãºltima coluna)
    y_header = y_atual - altura_cabecalho_dias
    c.rect(x0, y_header, x5 - x0, altura_cabecalho_dias, fill=0)

    for xv in (x1, x2, x3, x4, x5):
        c.line(xv, y_header, xv, y_header + altura_cabecalho_dias)

    c.setFont("Helvetica-Bold", 9)

    c.drawCentredString((x0 + x1) / 2,
                        y_header + (altura_cabecalho_dias / 2) - 3,
                        "DIA")
    c.drawCentredString((x1 + x2) / 2,
                        y_header + (altura_cabecalho_dias / 2) - 3,
                        "HE")
    c.drawCentredString((x2 + x3) / 2,
                        y_header + (altura_cabecalho_dias / 2) - 3,
                        "ENTRADA MANHA")
    c.drawCentredString((x3 + x4) / 2,
                        y_header + (altura_cabecalho_dias / 2) - 3,
                        "HS")
    c.drawCentredString((x4 + x5) / 2,
                        y_header + (altura_cabecalho_dias / 2) - 3,
                        "SAÃDA TARDE")
    # Ãºltima coluna SEM cabeÃ§alho

    y_atual = y_header

    # ============================================================
    # LINHAS DOS DIAS (Ãºltima coluna SEM linhas internas)
    # ============================================================
    dias_no_mes = calendar.monthrange(ano, mes)[1]
    total_linhas = 31
    altura_linha_dia = 5 * mm

    c.setFont("Helvetica-Bold", 9)

    # topo da tabela de dias fica logo abaixo do cabeÃ§alho
    y_top_tabela = y_header
    y_ultima_linha = y_top_tabela

    for dia in range(1, total_linhas + 1):
        y_row = y_ultima_linha - altura_linha_dia

        # retÃ¢ngulo DA LINHA atÃ© SAÃDA TARDE (nÃ£o entra na Ãºltima coluna)
        c.rect(x0, y_row, x5 - x0, altura_linha_dia, fill=0)

        # divisÃµes internas atÃ© SAÃDA TARDE
        for xv in (x1, x2, x3, x4, x5):
            c.line(xv, y_row, xv, y_row + altura_linha_dia)

        # DIA centralizado + marcaÃ§Ã£o de fins de semana e horÃ¡rios
        if dia <= dias_no_mes:
            dia_str = f"{dia:02d}"
            dow = calendar.weekday(ano, mes, dia)
            if dow == 5:  # sÃ¡bado
                he_text = "S"
                hs_text = "S"
            elif dow == 6:  # domingo
                he_text = "D"
                hs_text = "D"
            else:
                he_text = he or ""
                hs_text = hs or ""
        else:
            dia_str = "---"
            he_text = ""
            hs_text = ""

        c.drawCentredString(
            (x0 + x1) / 2,
            y_row + (altura_linha_dia / 2) - 3,
            dia_str
        )

        if he_text:
            c.drawCentredString(
                (x1 + x2) / 2,
                y_row + (altura_linha_dia / 2) - 3,
                he_text
            )
        if hs_text:
            c.drawCentredString(
                (x3 + x4) / 2,
                y_row + (altura_linha_dia / 2) - 3,
                hs_text
            )

        y_ultima_linha = y_row

    # ============================================================
    # COLUNA EXTRA ÃšNICA (SEM LINHAS INTERNAS, SEM CABEÃ‡ALHO)
    # ============================================================
    # coluna extra deve fechar atÃ© a linha superior do cabeÃ§alho
    y_top_coluna_extra = y_header + altura_cabecalho_dias
    altura_coluna_extra = y_top_coluna_extra - y_ultima_linha
    c.rect(x5, y_ultima_linha, largura_col_extra, altura_coluna_extra, fill=0)

    # Texto a ser repetido com espaÃ§o entre blocos
    bloco_texto = [
        "HORARIO",
        "CORRIDO",
        "DE",
        "ACORDO",
        "COM",
        "O DEC.",
        "NÂ° 11619",
        "DE 7:30",
        "HE AS",
        "13:30 HS",
    ]

    c.setFont("Helvetica-Bold", 7)

    line_h = 9  # altura aproximada da linha em pontos
    linhas_por_bloco = len(bloco_texto) + 1  # +1 linha em branco
    altura_bloco = linhas_por_bloco * line_h

    # quantos blocos cabem na coluna
    num_blocos = max(1, int(altura_coluna_extra // altura_bloco))

    x_centro = x5 + largura_col_extra / 2
    y_texto = y_top_tabela - line_h  # comeÃ§a um pouco abaixo do topo

    for _ in range(num_blocos):
        for linha in bloco_texto:
            if y_texto < y_ultima_linha + line_h:
                break
            c.drawCentredString(x_centro, y_texto, linha)
            y_texto -= line_h
        # linha em branco entre um bloco e outro
        y_texto -= line_h
        if y_texto < y_ultima_linha + line_h:
            break

    # ------------------------------------------------------------
    # RODAPÃ‰ COM ENDEREÃ‡O / CONTATOS / ASSINATURAS
    # ------------------------------------------------------------
    altura_footer = 5 * mm

    # linha 1: endereÃ§o (largura total)
    y_footer1 = y_ultima_linha - altura_footer
    c.rect(x, y_footer1, largura_tabela, altura_footer, fill=0)
    c.drawString(
        x + pad,
        y_footer1 + (altura_footer / 2) - 3,
        f"ENDEREÃ‡O: {endereco}"
    )

    # linha 2: CEP | TELEFONE | DATA
    y_footer2 = y_footer1 - altura_footer
    c.rect(x, y_footer2, largura_tabela, altura_footer, fill=0)
    col1 = largura_tabela * 0.35
    col2 = largura_tabela * 0.30
    x_col1 = x + col1
    x_col2 = x_col1 + col2
    c.line(x_col1, y_footer2, x_col1, y_footer2 + altura_footer)
    c.line(x_col2, y_footer2, x_col2, y_footer2 + altura_footer)
    c.drawString(x + pad, y_footer2 + (altura_footer / 2) - 3, f"CEP: {cep}")
    c.drawString(x_col1 + pad, y_footer2 + (altura_footer / 2) - 3, f"TELEFONE: {telefone}")
    c.drawString(x_col2 + pad, y_footer2 + (altura_footer / 2) - 3, "DATA: ____/____/_____")

    # linha 3: assinaturas
    y_footer3 = y_footer2 - altura_footer
    c.rect(x, y_footer3, largura_tabela, altura_footer, fill=0)
    x_meio = x + (largura_tabela / 2)
    c.line(x_meio, y_footer3, x_meio, y_footer3 + altura_footer)
    c.drawCentredString(
        x + (largura_tabela / 4),
        y_footer3 + (altura_footer / 2) - 3,
        "ASSINATURA DO REEDUCANDO"
    )
    c.drawCentredString(
        x + (3 * largura_tabela / 4),
        y_footer3 + (altura_footer / 2) - 3,
        "VISTO DO CHEFE"
    )

    # linha extra para o campo de assinatura de ambos
    altura_campo_assinatura = 8 * mm
    y_footer4 = y_footer3 - altura_campo_assinatura
    c.rect(x, y_footer4, largura_tabela, altura_campo_assinatura, fill=0)
    c.line(x_meio, y_footer4, x_meio, y_footer4 + altura_campo_assinatura)

    y_ultima_linha = y_footer4

    return y_ultima_linha
